{% extends "base.html" %}
{% block content %}

<h1>Form Purchase Order</h1>

<!-- Pesan dinamis -->
<div id="alert" style="display:none; padding:10px; margin-bottom:15px;"></div>

<form id="formPO">

  <div style="display:flex; gap:20px;">
    <!-- Kiri -->
    <div style="flex:1;">
      <label>Nomor PO</label>
      <input type="text" name="id_po" id="id_po" readonly placeholder="Otomatis">

      <label>Tanggal Pesanan</label>
      <input type="date" name="tanggal_order" id="tanggal_order" readonly value="{{ tanggal_order }}">

      <label>Nama Pemesan</label>
      <input type="text" name="nama_pemesan" id="nama_pemesan" required placeholder="Nama pemesan">

      <label>Alamat Kirim</label>
      <textarea name="alamat_kirim" id="alamat_kirim" required
          placeholder="Alamat lengkap pengiriman"
          style="width:100%; min-height:60px; resize:none; padding:6px; box-sizing:border-box;"></textarea>
    </div>

    <!-- Kanan -->
    <!-- Kanan -->
<div style="flex:1;">
  <label>Supplier</label>
  <select name="id_supplier" id="supplier" required>
    <option value="">Pilih Supplier</option>
    {% for s in supplier %}
      <option value="{{ s[0] }}">{{ s[1] }}</option>
    {% endfor %}
  </select>
  
  <label>Tanggal Kirim</label>
  <input type="date" name="tanggal_kirim" id="tanggal_kirim" required>

  <label>Pembayaran</label>
  <select name="jenis_pembayaran" id="jenis_pembayaran" required>
    <option value="">Pilih Pembayaran</option>
    <option value="TUNAI">Tunai</option>
    <option value="TRANSFER">Transfer</option>
    <option value="Tempo 7 Hari">Tempo 7 Hari</option>
    <option value="Tempo 14 Hari">Tempo 14 Hari</option>
    <option value="Tempo 30 Hari">Tempo 30 Hari</option>
  </select>
</div>
  </div>

  <h3>Detail Barang di Pilih</h3>

<table border="1" cellpadding="6" id="table-barang" style="width:100%;">
<tr>
  <th style="width:30%;">Barang Dipilih</th>
  <th style="width:10%;">Qty</th>
  <th style="width:15%;">Harga</th>
  <th style="width:15%;">Subtotal</th>
  <th style="width:20%;">Note</th>
  <th style="width:10%;">Aksi</th>
</tr>
</table>

<!-- Ringkasan (muncul & update saat barang ditambah) -->
<table style="width:100%; margin-top:10px; border-collapse:collapse;">
  <tr>
    <td style="text-align:right; padding:4px 8px; width:65%;"><strong>Total:</strong></td>
    <td style="text-align:right; padding:4px 8px; width:15%;"><span id="grand_total">0</span></td>
    <td style="width:20%;"></td>
    
  </tr>
</table>
<table border="1" cellpadding="6" id="table-barang" style="width:100%;">
<tr>
<th style="width:35%;">Barang</th> <th style="width:10%;">Qty</th> <th style="width:15%;">Harga</th> <th style="width:15%;">Subtotal</th> <th style="width:15%;">Aksi</th>
</tr>
</table>
<!-- Form input barang -->
<div style="display:flex; gap:10px; margin-top:5px; align-items:flex-start; flex-wrap:wrap;">
  <div style="flex:2.1; display:flex; flex-direction:column;">
    <select id="barang">
      <option value="">Pilih Barang</option>
    </select>
    <!-- Stok & spesifikasi -->

       <div style="display: flex; gap: 15px; align-items: flex-start;">
    <textarea id="stok_spek" readonly
        style="margin-top:5px; width:100%; min-height:100px; resize:none; padding:4px; box-sizing:border-box;"
        placeholder="Stok dan spesifikasi barang akan muncul di sini"></textarea>


  <textarea id="note" placeholder="Catatan untuk barang ini" 
    style="margin-top:5px; width:100%; min-height:100px; resize:none; padding:4px; box-sizing:border-box;"></textarea>  
</div>
      
  </div>
  
 <div style="position:relative; flex:0.5;">
  <input type="number" id="qty" value="1" min="1"
         style="width:100%; padding-right:4px;">
  <span id="qty_satuan" style="
    position:absolute;
    right:5px;
    top:50%;
    transform:translateY(-50%);
    color:#666;
    font-size:13px;
    pointer-events:none;
  ">-</span>
</div>
  <input type="number" id="harga" readonly style="flex:0.7;">
  <input type="number" id="subtotal" readonly style="flex:0.7;">
  <button type="button" id="add-barang" style="flex:1;">Tambah Barang</button>
</div>



  <br>
  <button type="submit">Simpan PO</button>
</form>


<!-- MODAL PREVIEW -->
<div id="previewModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:999;
">
  <div style="
    background:#fff;
    width:90%;
    max-width:900px;
    margin:5% auto;
    padding:20px;
    border-radius:10px;
    max-height:85vh;
    overflow:auto;
  ">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>üìÑ Preview Purchase Order</h2>
      <span id="closePreview" style="cursor:pointer;font-size:22px;">‚úñ</span>
    </div>

    <div id="previewContent"></div>

    <hr>
    <div style="text-align:right; margin-top:10px;">
  <button type="button" id="btnBatal">‚ùå Tidak</button>
<button type="button" id="btnLanjut">‚úÖ Simpan</button>
</div>
  </div>
</div>



<script>
const supplier = document.getElementById("supplier");
const barang = document.getElementById("barang");
const qty = document.getElementById("qty");
const harga = document.getElementById("harga");
const subtotal = document.getElementById("subtotal");
const table = document.getElementById("table-barang");
const addBtn = document.getElementById("add-barang");
const idPoInput = document.getElementById("id_po");
const alamat = document.getElementById("alamat_kirim");
const alertDiv = document.getElementById("alert");
const stokSpek = document.getElementById("stok_spek");
const grandTotalEl = document.getElementById("grand_total");

let barangList = [];

function formatAngka(n){
  const num = Number(n || 0);
  return num.toLocaleString("id-ID");
}

function updateRingkasan(){
  const grandSubtotal = barangList.reduce((acc, b) => acc + (Number(b.sub) || 0), 0);
  // Jika belum ada pajak/diskon, total = subtotal
  const total = grandSubtotal;
  grandTotalEl.textContent = formatAngka(total);
}

function resetQty() {
  qty.value = 1;                 // reset jumlah
  document.getElementById("qty_satuan").innerText = "-"; // hapus satuan
}

function clearPOForm(){
  // reset input form
  document.getElementById("nama_pemesan").value = "";
  alamat.value = "";
  alamat.style.height = "auto";
  document.getElementById("tanggal_kirim").value = "";

  // reset supplier & barang
  supplier.value = "";
  supplier.dataset.lastValue = "";
  idPoInput.value = "";
  barang.innerHTML = "<option value=''>Pilih Barang</option>";
  stokSpek.value = "";
  

  // reset input barang
  barang.value = "";
  harga.value = 0;
  subtotal.value = 0;
  addBtn.disabled = true;
  resetQty();
  
  // reset tabel & list
  barangList = [];
  table.querySelectorAll("tr:not(:first-child)").forEach(tr => tr.remove());
  updateRingkasan();
}


// Auto-resize textarea
alamat.addEventListener("input", () => {
    alamat.style.height = "auto";
    alamat.style.height = alamat.scrollHeight + "px";
});

// Generate nomor PO saat supplier dipilih
supplier.addEventListener('change', ()=>{
    const s = supplier.value;
    if(!s){ idPoInput.value=''; return; }
    const d = new Date(); 
    const yyyy=d.getFullYear(); 
    const mm=String(d.getMonth()+1).padStart(2,'0');
    idPoInput.value = `PO-${yyyy}${mm}-${s}-XXXX`;
    resetQty();
});
supplier.addEventListener("change", () => {
  if(barangList.length > 0){
    showAlert("Tidak bisa ganti supplier setelah barang ditambahkan!", "error");
    supplier.value = supplier.dataset.lastValue || "";
    return;
  }
  supplier.dataset.lastValue = supplier.value;

  barang.innerHTML = "<option value=''>Loading...</option>";
  fetch(`/get_barang/${supplier.value}`)
    .then(res => res.json())
    .then(data => {
      barang.innerHTML = "<option value=''>Pilih Barang</option>";
      data.barang.forEach(b => {
        // Tambahkan data stok & spesifikasi di data attributes
      barang.innerHTML += `
        <option 
          value="${b.id}" 
          data-harga="${b.harga}" 
          data-stok="${b.stok}" 
          data-spek="${b.spek}"
          data-satuan="${b.satuan}">
          ${b.nama}
        </option>`;      
      });
    });
});

function setQtyError(isError){
    if(isError){
        qty.style.border = "2px solid #dc3545";
        qty.style.backgroundColor = "#f8d7da";
    } else {
        qty.style.border = "";
        qty.style.backgroundColor = "";
    }
}
// Update harga & subtotal

function updateHarga() {
    const opt = barang.selectedOptions[0];
  if (!opt|| !opt.value) {
    harga.value = 0;
    subtotal.value = 0;
    stokSpek.value = "";
    setQtyError(false);
    addBtn.disabled = true;
    document.getElementById("qty_satuan").innerText = "-";
    document.getElementById("note").value = "";
    return;
  }

  const h = parseFloat(opt.dataset.harga);
  const stok = parseInt(opt.dataset.stok);
  const q = parseInt(qty.value);
  const satuan = opt.dataset.satuan || "-";

  harga.value = h;
  subtotal.value = q * h;
document.getElementById("qty_satuan").innerText = satuan;

stokSpek.value =
  `Stok: ${stok} ${satuan}\n` +
  `Satuan: ${satuan}\n` +
  `Spesifikasi:\n${opt.dataset.spek || "-"}`;
  if (q > stok) {
        setQtyError(true);
        addBtn.disabled = true;
        showAlert(`Qty melebihi stok! Maksimal ${stok}`, "error");
    } else {
        setQtyError(false);
        addBtn.disabled = false;
    }
}
barang.addEventListener("change", updateHarga);
qty.addEventListener("input", updateHarga);

// Tambah barang ke tabel
addBtn.addEventListener("click", () => {
    const opt = barang.selectedOptions[0];
    if (!opt) return showAlert("Pilih barang!", "error");

    const id     = barang.value;
    const nama   = opt.text;
    const satuan = opt.dataset.satuan || "-";
    const h      = parseFloat(harga.value);
    const q      = parseInt(qty.value);
    const sub    = h * q;

    if (barangList.some(b => b.id === id))
        return showAlert("Barang sudah ditambahkan!", "error");
const noteText = document.getElementById("note").value || "-";

barangList.push({ id, nama, h, q, sub, satuan, note: noteText });

const tr = document.createElement("tr");
tr.innerHTML = `
  <td>
    ${nama}
    <input type="hidden" name="id_barang_list[]" value="${id}">
  </td>
  <td>
    ${q} ${satuan}
    <input type="hidden" name="qty_list[]" value="${q}">
  </td>
  <td>${formatAngka(h)}</td>
  <td>${formatAngka(sub)}</td>
  <td>
    ${noteText}
    <input type="hidden" name="note_list[]" value="${noteText}">
  </td>
  <td><button type="button" class="hapus">Hapus</button></td>
`;
    table.appendChild(tr);

    tr.querySelector(".hapus").addEventListener("click", () => {
        barangList = barangList.filter(b => b.id !== id);
        tr.remove();
        updateRingkasan();
        resetQty();
    });


    
   // reset input
      barang.value = "";
      qty.value = 1;
      harga.value = 0;
      subtotal.value = 0;
      stokSpek.value = "";
      document.getElementById("note").value = ""; // <<< TAMBAHKAN INI
      addBtn.disabled = true;

    updateRingkasan();
});

// Show alert dinamis
function showAlert(msg, type="success"){
    alertDiv.style.display="block";
    alertDiv.style.backgroundColor = type==="error"?"#f8d7da":"#d4edda";
    alertDiv.style.color = type==="error"?"#721c24":"#155724";
    alertDiv.style.border = type==="error"?"1px solid #f5c6cb":"1px solid #c3e6cb";
    alertDiv.innerText = msg;
    setTimeout(()=>alertDiv.style.display="none", 5500);
}

// Submit via AJAX
function simpanPO() {
  const formData = new FormData();

  formData.append("id_supplier", supplier.value);
  formData.append("tanggal_kirim", tanggal_kirim.value);
  formData.append("nama_pemesan", nama_pemesan.value);
  formData.append("alamat_kirim", alamat.value);
  formData.append("jenis_pembayaran", jenis_pembayaran.value);
  formData.append("status", "DRAF");

  barangList.forEach(b=>{
    formData.append("id_barang_list", b.id);
    formData.append("qty_list", b.q);
    formData.append("note_list", b.note);
  });

  fetch("/simpan_po_ajax", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
  if (data.status === "error") {
    showAlert(data.message, "error");
  } else {
    showAlert("‚úÖ PO berhasil disimpan!", "success");
    clearPOForm();
    resetQty();
  }
})
.catch(() => {
  showAlert("Gagal menyimpan PO", "error");
});
}
// Load barang berdasarkan supplier


// Update harga, subtotal, stok & spesifikasi

</script>
<script>
const form = document.getElementById("formPO");
const previewModal   = document.getElementById("previewModal");
const previewContent = document.getElementById("previewContent");
const btnBatal  = document.getElementById("btnBatal");
const btnLanjut = document.getElementById("btnLanjut");

let lanjutSimpan = false; // FLAG PENTING

form.addEventListener("submit", e => {
  // kalau belum konfirmasi ‚Üí tampilkan preview
     e.preventDefault();

    if (barangList.length === 0) {
      showAlert("Harap tambahkan minimal 1 barang!", "error");
      return;
    }

    tampilkanPreview();
    previewModal.style.display = "block";
  
});

// ================= PREVIEW =================
function tampilkanPreview(){
  const supplierText = supplier.selectedOptions[0]?.text || "-";

  let html = `
    <p><b>No PO:</b> ${idPoInput.value}</p>
    <p><b>Tanggal Order:</b> ${tanggal_order.value}</p>
    <p><b>Nama Pemesan:</b> ${nama_pemesan.value}</p>
    <p><b>Supplier:</b> ${supplierText}</p>
    <p><b>Tanggal Kirim:</b> ${tanggal_kirim.value}</p>
    <p><b>Jenis Pembayaran:</b> ${jenis_pembayaran.value}</p>
    <p><b>Alamat Kirim:</b><br>${alamat.value}</p>

    <hr>

    <table border="1" width="100%" cellpadding="6" style="border-collapse:collapse;">
      <tr>
        <th>Barang</th>
        <th>Qty</th>
        <th>Harga</th>
        <th>Subtotal</th>
        <th>Catatan</th>
      </tr>
  `;

  let total = 0;
  barangList.forEach(b => {
    total += b.sub;
    html += `
      <tr>
        <td>${b.nama}</td>
        <td>${b.q} ${b.satuan}</td>
        <td>${formatAngka(b.h)}</td>
        <td>${formatAngka(b.sub)}</td>
        <td>${b.note || "-"}</td>
      </tr>
    `;
  });

  html += `
    <tr>
      <td colspan="3" align="right"><b>Total</b></td>
      <td colspan="2"><b>${formatAngka(total)}</b></td>
    </tr>
    </table>
  `;

  previewContent.innerHTML = html;
}

// ================= TOMBOL MODAL =================
const closePreview = document.getElementById("closePreview");

closePreview.onclick = () => {
  previewModal.style.display = "none";
};

btnBatal.onclick = () => {
  previewModal.style.display = "none";
};

btnLanjut.onclick = () => {
  previewModal.style.display = "none";
  simpanPO();
};

previewModal.onclick = e => {
  if (e.target === previewModal) {
    previewModal.style.display = "none";
  }
};
</script>
{% endblock %}
